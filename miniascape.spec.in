Name:           @PACKAGE@
Version:        @VERSION@
Release:        1%{?dist}
Summary:        Micro cloud build tools and runtime environments
Group:          Development/System
License:        GPLv3+
URL:            http://github.com/ssato/@PACKAGE@
Source0:        %{name}-%{version}.tar.@SOURCE_ZIP_EXT@
# TODO: Which is better?
#BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
BuildRoot:      %(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)
BuildArch:      noarch
BuildRequires:  python
BuildRequires:  python-cheetah
## Needed for 'make check':
#BuildRequires:  python-nose
#BuildRequires:  python-augeas
#BuildRequires:  pyxattr
#BuildRequires:  autoconf
#BuildRequires:  automake
BuildRequires:  PyYAML
BuildRequires:  libvirt-python
BuildRequires:  rpm-build
BuildRequires:  /usr/bin/qemu-img
Requires:       autoconf
Requires:       automake
Requires:       libvirt
Requires:       libvirt-python
Requires:       PyYAML
Requires:       python-cheetah
#Requires:       python-augeas
Requires:       pyxattr
Requires:       rpm-build
Requires:       /usr/bin/qemu-img
Requires:       fence-agents
Requires(preun):/sbin/service, /sbin/chkconfig
Requires(post): /sbin/service, /sbin/chkconfig


%description
Network and other necessary infrastructure data for libvirt guest domains. It
contains libvirt network definitions, dnsmasq and iscsi configurations for
virtualization environment.


%package        refdata
Summary:        Reference data for @PACKAGE@
Group:          Development/System
Requires:       @PACKAGE@
Provides:       @PACKAGE@-data
Requires(preun):/sbin/service, %{_sbindir}/miniascape
Requires(post): /sbin/service, %{_sbindir}/miniascape


%description    refdata
@PACKAGE@ reference data. Actually, it just contains network
registration/update/unregistration scriptlets.


%prep
%setup -q


%build
%configure --with-rhel-installation-key='@RHEL_INSTALLATION_KEY@' --with-password='@KICKSTART_PASSWORD@'
make %{?_smp_mflags}
#make check


%install
%{__rm} -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT


%pre
#if [ $1 = 2 ]; then  # update
#    ...
#fi


%preun
if [ $1 = 0 ]; then  # erase
    for net in net-1 net-2 net-3; do chkconfig --del dnsmasq-$net; done
fi


%preun  refdata
if [ $1 = 0 ]; then
    for net in net-1 net-2 net-3; do %{_sbindir}/miniascape net unregister $net; done
fi


%post
if [ $1 = 1 ]; then    # install
    for net in net-1 net-2 net-3; do /sbin/chkconfig --add dnsmasq-$net; done
elif [ $1 = 2 ]; then  # update
    for net in net-1 net-2 net-3; do /sbin/service dnsmasq-$net condrestart; done
fi


%post  refdata
if [ $1 = 1 ]; then
    for net in net-1 net-2 net-3; do
        %{_sbindir}/miniascape net register $net
        /sbin/service libvirtd status 2>/dev/null >/dev/null && /sbin/service dnsmasq-$net start || :
    done
elif [ $1 = 2 ]; then
    for net in net-1 net-2 net-3; do
        %{_sbindir}/miniascape net register $net
        /sbin/service dnsmasq-$net condrestart
    done
fi


%clean
%{__rm} -rf $RPM_BUILD_ROOT


%files
%defattr(-,root,root,-)
%doc README
%dir %{_localstatedir}/lib/@PACKAGE@
%config(noreplace) %{_sysconfdir}/@PACKAGE@/networks/*
%config(noreplace) %{_sysconfdir}/nginx/conf.d/*
%config(noreplace) %{_sysconfdir}/sysconfig/fence_xvmd
%config(noreplace) %{_sysconfdir}/cluster/*
%{_sbindir}/*
%{_sysconfdir}/rc.d/init.d/dnsmasq-*
%{_sysconfdir}/rc.d/init.d/fence_xvmd
%{_libexecdir}/@PACKAGE@/*
%{_datadir}/@PACKAGE@/*/*.*
%{_datadir}/@PACKAGE@/*/*/*.*
%{_datadir}/@PACKAGE@/*/*/*/*.*
%{_localstatedir}/lib/@PACKAGE@/networks/*.xml
%{_localstatedir}/lib/@PACKAGE@/networks/dnsmasq/*


%files  refdata
%defattr(-,root,root,-)


%changelog
* Sun Jan 31 2010 Satoru SATOH <satoru.satoh@gmail.com> - 0.1.99-1
- A lot of packaging bug fixes
- Restructured modules
- Merged cluster sub-package
- Split net [de]activatin scriptlets into refdata sub-package
- Cleanup-ed file list

* Wed Oct 28 2009 Satoru SATOH <satoru.satoh@gmail.com> - 0.1-1
- Initial packaging
