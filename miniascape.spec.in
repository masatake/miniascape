Name:           @PACKAGE@
Version:        @VERSION@
Release:        1%{?dist}
Summary:        Micro cloud build tools and runtime environments
Group:          Development/System
License:        GPLv3+
URL:            http://github.com/ssato/@PACKAGE@
Source0:        %{name}-%{version}.tar.@SOURCE_ZIP_EXT@
# TODO: Which is better?
#BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
BuildRoot:      %(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)
BuildArch:      noarch
BuildRequires:  python
## Needed for 'make check':
#BuildRequires:  python-nose
#BuildRequires:  python-augeas
#BuildRequires:  pyxattr
#BuildRequires:  libvirt-python
#BuildRequires:  autoconf
#BuildRequires:  automake
#BuildRequires:  rpm-build
#BuildRequires:  qemu-img
Requires:       autoconf
Requires:       automake
Requires:       libvirt
Requires:       libvirt-python
#Requires:       python-augeas
Requires:       pyxattr
Requires:       rpm-build
Requires:       qemu-img


%description
Network and other necessary infrastructure data for libvirt guest domains. It
contains libvirt network definitions, dnsmasq and iscsi configurations for
virtualization environment.


%package        cluster
Summary:        Cluster related configurations for guest cluster nodes
Group:          Development/System
Requires:       @PACKAGE@
Requires:       fence-agents


%description    cluster
Cluster related configurations for guest cluster nodes


%prep
%setup -q


%build
%configure --with-rhel-installation-key='@RHEL_INSTALLATION_KEY@' --with-password='@KICKSTART_PASSWORD@'
make %{?_smp_mflags}
#make check


%install
%{__rm} -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT


%pre
#if [ $1 = 2 ]; then  # update
#    ...
#fi


%preun
if [ $1 = 0 ]; then  # erase
    /usr/libexec/@PACKAGE@/pre-uninstall
fi


%post
if [ $1 = 1 ]; then    # install
    /usr/libexec/@PACKAGE@/post-install

elif [ $1 = 2 ]; then  # update
    /usr/libexec/@PACKAGE@/post-update
fi


%clean
%{__rm} -rf $RPM_BUILD_ROOT


%files
%defattr(-,root,root,-)
%doc README
%dir %{_localstatedir}/lib/@PACKAGE@
%config %{_sysconfdir}/@PACKAGE@/networks/*
%config %{_sysconfdir}/nginx/conf.d/*
%{_sysconfdir}/rc.d/init.d/dnsmasq-*
%{_libexecdir}/@PACKAGE@/*
%{_datadir}/@PACKAGE@/*
%{_datadir}/@PACKAGE@/*/*
%{_datadir}/@PACKAGE@/*/*/*


%files  cluster
%config(noreplace) %{_sysconfdir}/sysconfig/fence_xvmd
%{_sysconfdir}/cluster/*
%{_sysconfdir}/rc.d/init.d/fence_xvmd


%changelog
* Wed Oct 28 2009 Satoru SATOH <satoru.satoh@gmail.com> - 0.1-1
- Initial packaging
