{#- Jinja2 (http://jinja.pocoo.org) based kickstart template for RHEL guests. -#}
# see also: http://red.ht/hvPnf3
{%  block kickstart_options -%}
install
{%    block location -%}
{%      include "snippets/ks/main.location" -%}
{%-   endblock %}
text
{%    block bootloader -%}
{%      include "snippets/ks/main.bootloader" %}
{%-   endblock %}
{%    block keyboard -%}
{%      include "snippets/ks/main.keyboard" -%}
{%-   endblock %}
{%    include "snippets/ks/main.lang" %}
{%    block rootpw -%}
{%      include "snippets/ks/main.rootpw" %}
{%-   endblock %}
{%    block timezone -%}
{%      include "snippets/ks/main.timezone" -%}
{%-   endblock %}
{%    block basic_options -%}
selinux --{{ selinux|default('enforcing') }}
skipx
{%-   endblock %}
{%    block authconfig -%}
{%      include "snippets/ks/main.auth" -%}
{%-   endblock %}
{%    include "snippets/ks/main.yum_repos" -%}
{%    include "snippets/ks/main.groups" -%}
{%    include "snippets/ks/main.users" -%}
{%    block firewall -%}
{%      include "snippets/ks/main.firewall" -%}
{%-   endblock %}
{%    block firstboot -%}
{%      include "snippets/ks/main.firstboot" -%}
{%-   endblock %}
{%    include "snippets/ks/main.services" -%}
{%    block network -%}
{%      if kickstart and kickstart.dynamic_network -%}
{{        "%include /tmp/network-ks.cfg" }}
{%      else -%}
{%        include "snippets/ks/main.network" -%}
{%      endif %}
{%-   endblock %}
{%    block partition -%}
{%      include "snippets/ks/main.partitions" -%}
{%-   endblock %}
{%- endblock %}
{%  block kickstart_extra_options -%}
{{    kickstart.finish|default('reboot') }}
{%- endblock %}

{%  block addons -%}
{%- endblock %}

%packages {{ kickstart.packages.options|default('--ignoremissing') }}
{%  block packages -%}
{%     include "snippets/ks/packages" %}
{%- endblock %}

{% set pre_log_option = ' --log=/mnt/sysimage/root/ks-pre.log' if virtinst and virtinst.os_variant in ('rhel7', 'fedora21') -%}
%pre {{ kickstart.pre.options if kickstart and kickstart.pre and kickstart.pre.options }}{{ pre_log_option if pre_log_option }}
{% block pre_wrapped -%}
{%   block pre -%}
{%      include "snippets/pre.logging" %}
{%      if kickstart and kickstart.dynamic_network -%}
{%          include "snippets/pre.store_cmdline" %}
{%          if virtinst and virtinst.os_variant in ('rhel7', 'fedora21') -%}
{%              include "snippets/pre.dynamic_network.rhel-7" %}
{%          else -%}
{%              include "snippets/pre.dynamic_network" %}
{%          endif -%}
{%      else -%}
{%          if store_cmdline -%}
{%              include "snippets/pre.store_cmdline" %}
{%          endif -%}
{%      endif -%}
{%      for snippet in kickstart.pre_snippets -%}
{{          snippet }}
{%      endfor %}
{%   endblock -%}
{% endblock %}

{% set post_nochroot_log_option = ' --log=/mnt/sysimage/root/ks-post-nochroot.log' if virtinst and virtinst.os_variant in ('rhel7', 'fedora21') -%}
%post --nochroot {{ kickstart.post_nochroot.options if kickstart and kickstart.post_nochroot and kickstart.post_nochroot.options }}{{ post_nochroot_log_option if post_nochroot_log_option }}
{%  block post_nochroot_wrapped -%}
{%    block post_nochroot -%}
test -d /mnt/sysimage/root/setup || mkdir -p /mnt/sysimage/root/setup
test -f /tmp/boot-params && cp -f /tmp/boot-params /mnt/sysimage/root/setup
{%-   endblock -%}
{%- endblock %}

{% set post_log_option = ' --log=/root/ks-post.log' if virtinst and virtinst.os_variant in ('rhel7', 'fedora21') -%}
%post {{ kickstart.post.options if kickstart and kickstart.post and kickstart.post.options }}{{ post_log_option if post_log_option }}
{% block post_wrapped -%}
{%   block post -%}
{%      include "snippets/post.logging" %}
{%      include "snippets/post.import_rhel_gpgkey" %}
{%      include "snippets/post.setup_yum_repos" %}
{%      for ni in interfaces if ni.bootproto == 'dhcp' -%}
{%          if loop.first -%}
# Network config files anaconda generated will be used...
{%-         endif -%}
{%      else -%}
{%          if not (kickstart and kickstart.dynamic_network) -%}
{%              include "snippets/post.generate_etc_sysconfig_network_files" %}
{%-         endif -%}
{%          include "snippets/post.generate_resolv.conf" %}
{%      endfor %}
{%      if ntpservers is defined and ntpservers -%}
{%          include "snippets/post.update_ntp.conf" -%}
{%      endif %}
{%      if ssh_root_acces is defined and not ssh_root_acces -%}
{%          include "snippets/post.update_sshd_config" -%}
{%      endif %}
{%      if generate_hosts is defined and generate_hosts -%}
{%          include "snippets/post.generate_hosts" -%}
{%      endif %}
{%      if setup_screen is defined and setup_screen -%}
{%          include "snippets/post.root_screenrc" -%}
{%      endif %}
{%      include "snippets/post.custom_script" %}
{%   endblock -%}
{% endblock %}
