{#- Jinja2 (http://jinja.pocoo.org) based kickstart template for RHEL guests. -#}
# see also: http://red.ht/hvPnf3
{%  block kickstart_options -%}
install
{%    block location -%}
{%      include "snippets/ks/main.location" -%}
{%-   endblock %}
text
{%    block bootloader -%}
{%      include "snippets/ks/main.bootloader" %}
{%-   endblock %}
{%    block keyboard -%}
{%      include "snippets/ks/main.keyboard" -%}
{%-   endblock %}
{%    include "snippets/ks/main.lang" %}
{%    block rootpw -%}
{%      include "snippets/ks/main.rootpw" %}
{%-   endblock %}
{%    block timezone -%}
{%      include "snippets/ks/main.timezone" -%}
{%-   endblock %}
{%    block basic_options -%}
selinux --{{ selinux|default('enforcing') }}
skipx
{%-   endblock %}
{%    block authconfig -%}
{%      include "snippets/ks/main.auth" -%}
{%-   endblock %}
{%    include "snippets/ks/main.yum_repos" -%}
{%    include "snippets/ks/main.groups" -%}
{%    include "snippets/ks/main.users" -%}
{%    block firewall -%}
{%      include "snippets/ks/main.firewall" -%}
{%-   endblock %}
{%    block firstboot -%}
{%      include "snippets/ks/main.firstboot" -%}
{%-   endblock %}
{%    include "snippets/ks/main.services" -%}
{%    block network -%}
{%      if kickstart and kickstart.dynamic_network -%}
{{        "%include /tmp/network-ks.cfg" }}
{%      else -%}
{%        include "snippets/ks/main.network" -%}
{%      endif %}
{%-   endblock %}
{%    block partition -%}
{%      include "snippets/ks/main.partitions" -%}
{%-   endblock %}
{%- endblock %}
{%  block kickstart_extra_options -%}
{{    kickstart.finish|default('reboot') }}
{%- endblock %}

{%  block addons -%}
{%- endblock %}

%packages {{ kickstart.packages_options|default('--ignoremissing') }}
{% block packages -%}
{%   block packages_installed -%}
{%     include "data/rhel_basic_tools_rpms" %}
{%     if packages is defined and packages.add is defined -%}
# Added:
{%       for p in packages.add %}{{ p }}
{%       endfor -%}
{%     endif -%}
{%   endblock %}
{%   block packages_not_installed -%}
{%     include "data/rhel_uninstalled_rpms" %}
{%   endblock -%}
{% endblock %}

%pre {{ kickstart.pre.options if kickstart and kickstart.pre and kickstart.pre.options }}
{% block pre_wrapped -%}
{%   block pre -%}
{%      include "snippets/pre.logging" if not (kickstart and kickstart.pre and kickstart.pre.options and '--log' in kickstart.pre.options) %}
{%      if kickstart and kickstart.dynamic_network -%}
{%          include "snippets/pre.store_cmdline" %}
{%          include "snippets/pre.dynamic_network" %}
{%      else -%}
{%          if store_cmdline -%}
{%              include "snippets/pre.store_cmdline" %}
{%          endif -%}
{%      endif -%}
{%      for snippet in kickstart.pre_snippets -%}
{{          snippet }}
{%      endfor %}
{%   endblock -%}
{% endblock %}

%post --nochroot {{ kickstart.post_nochroot.options if kickstart and kickstart.post_nochroot and kickstart.post_nochroot.options }}
{%  block post_nochroot_wrapped -%}
{%    block post_nochroot -%}
test -d /mnt/sysimage/root/setup || mkdir -p /mnt/sysimage/root/setup
test -f /tmp/boot-params && cp -f /tmp/boot-params /mnt/sysimage/root/setup
{%    endblock -%}
{%- endblock %}

%post {{ kickstart.post.options if kickstart and kickstart.post and kickstart.post.options }}
{% block post_wrapped -%}
{%   block post -%}
{%      include "snippets/post.logging" if not (kickstart and kickstart.post and kickstart.post.options and '--log' in kickstart.post.options) %}
{%      include "snippets/post.import_rhel_gpgkey" %}
{%      include "snippets/post.setup_yum_repos" %}
{%      for ni in interfaces if ni.bootproto == 'dhcp' -%}
{%          if loop.first -%}
# Network config files anaconda generated will be used...
{% endif -%}
{%      else -%}
{%          include "snippets/post.generate_etc_sysconfig_network_files" %}
{%          include "snippets/post.generate_resolv.conf" %}
{%      endfor %}
{%      if ntpservers is defined and ntpservers -%}
{%          include "snippets/post.update_ntp.conf" -%}
{%      endif %}
{%      if ssh_root_acces is defined and not ssh_root_acces -%}
{%          include "snippets/post.update_sshd_config" -%}
{%      endif %}
{%      if generate_hosts is defined and generate_hosts -%}
{%          include "snippets/post.generate_hosts" -%}
{%      endif %}
{%      if setup_screen is defined and setup_screen -%}
{%          include "snippets/post.root_screenrc" -%}
{%      endif %}
{%      include "snippets/post.custom_scripts" %}
{%   endblock -%}
{% endblock %}
