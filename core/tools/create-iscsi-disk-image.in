#! /bin/bash
set -e

parted=/sbin/parted


if test $# -lt 1; then
  echo "Usage: $0 <storage_image_path> [<storage_size> <iscsi_target_name>]"
  exit 1
fi

DISK_IMAGE_PATH=$1
DISK_IMAGE_SIZE=${2:-100}

if test -f $DISK_IMAGE_PATH; then
  echo "[Error] $DISK_IMAGE_PATH: already exists! remove it first"
  exit 1
fi

# compute the iscsi target name from $DISK_IMAGE_PATH
#iscsi_target_name=${DISK_IMAGE_PATH##*/}
iscsi_target_name=`echo ${DISK_IMAGE_PATH} | sed -re "s,/.+[^/]+/([^.]+)..+,\1,g"`

if test $# -ge 3; then iscsi_target_name=$3; fi


dd if=/dev/zero of=$DISK_IMAGE_PATH bs=1M count=$DISK_IMAGE_SIZE

$parted --script $DISK_IMAGE_PATH mklabel msdos
$parted --script $DISK_IMAGE_PATH mkpartfs primary ext2 0 $DISK_IMAGE_SIZE


# [scsi-target-utils (tgt)]
tgtconf=/etc/tgt/conf.d/$iscsi_target_name.conf

if test -f $tgtconf; then
    echo "$tgtconf already exists! Aborting..."
    exit 1
fi
cat << EOF > $tgtconf
<target @ISCSI_TARGET_IQN@:$iscsi_target_name>
    backing-store $DISK_IMAGE_PATH      # LUN1
    initiator-address @NET_1_NETWORK@.0/24
</target>
EOF
#service tgtd reload


# [NetBSD iSCSI]
#
# # /etc/iscsi/targets:
# # extent0 /var/lib/libvirt/images/rhel-5-cluster-2nodes-shared-1.raw 0 100MB
# # target0 rw      extent0 192.168.51.0/24
# grep -q $shareddisk_img /etc/iscsi/targets > /dev/null; ret=$?
# if test $ret -eq 1; then   # new
#     cat << EOF >> /etc/iscsi/targets
#
# # @CLUSTER_2NODES_SHARED_1@
# extent1 $DISK_IMAGE_PATH 0 ${DISK_IMAGE_SIZE}MB
# target1 rw      extent1 192.168.51.0/24
#
# EOF
#
# fi
