%define pkgname_        __PKGNAME__
%define name_           __NAME__
%define ver_            __VER__

%define guest_xmldir    %{_sysconfdir}/libvirt/qemu
%define guest_xmlsavedir    %{_localstatedir}/lib/virt-guest
%define guest_imgdir    %{_localstatedir}/lib/libvirt/images/%{name_}
%define guest_imgsuffix __DISK_FMT__
%define guest_initial_img_suffix        __INITIAL_DISK_SUFFIX__

%define other_deps_     "__OTHER_DEPS__"
%define has_other_deps_ %(test -n "__OTHER_DEPS__" && echo 1 || echo 0)

%define buildhost       %(hostname)

# disable debuginfo
%define debug_package %{nil}

# FIXME
%define arch_  __ARCH__


Name:           %{pkgname_}
Version:        %{ver_}
Release:        1%{?dist}
Summary:        KVM/Qemu guest base image and config for %{name_}
Group:          Development/System
License:        MIT
URL:            http://localhost.localdomain
Source0:        %{name}-%{version}.tar.xz
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
#BuildArch:      %{arch_}
Requires:       /usr/bin/virsh
Requires:       @PACKAGE@
Requires:       %{name}-base
%if %{has_other_deps_}
Requires:       %{other_deps_}
%endif


%description
Virtualization (KVM/Qemu) guest image and data for %{name_}


%package        base
Summary:        KVM/Qemu guest system image for %{name_}
Group:          Development/System
Provides:       %{name}-base


%description    base
KVM/Qemu guest system image for %{name_}.

This package provides base system disk images required for %{name}.


%prep
%setup -q


%build


%install
%{__rm} -rf $RPM_BUILD_ROOT

# 1. guest's xml definition file (will be replaced by libvirtd)
install -d $RPM_BUILD_ROOT/%{guest_xmldir}
install -m 600 %{name_}.xml $RPM_BUILD_ROOT/%{guest_xmldir}

# 2. ... and its backup
install -d $RPM_BUILD_ROOT/%{guest_xmlsavedir}
install -m 600 %{name_}.xml $RPM_BUILD_ROOT/%{guest_xmlsavedir}

# TODO: What permissions are suited for libvirt images?
install -d $RPM_BUILD_ROOT/%{guest_imgdir}
for img in $(ls *.%{guest_imgsuffix}); do
    is_base=$(echo $img | grep -q base.%{guest_imgsuffix} 2>/dev/null && echo 0 || echo 1)

    if test $is_base = 0; then
        install -m 400 $img $RPM_BUILD_ROOT/%{guest_imgdir}
    else
        install -m 600 $img $RPM_BUILD_ROOT/%{guest_imgdir}
        # delta image backup 
        install -m 400 $img $RPM_BUILD_ROOT/%{guest_imgdir}/$img.%{guest_initial_img_suffix}
    fi
done


# disk base images will be included in sub package
find $RPM_BUILD_ROOT/%{guest_imgdir} -type f | grep "base.%{guest_imgsuffix}" | \
        sed -e "s!$RPM_BUILD_ROOT!!g" > base.files

find $RPM_BUILD_ROOT/%{guest_imgdir} -type f | grep -v "base.%{guest_imgsuffix}" | \
        sed -e "s!$RPM_BUILD_ROOT!!g" > delta.files


%preun
if [ $1 = 0 ]; then  # erase
    if `/usr/bin/virsh list | grep -q %{name_} 2>/dev/null`; then
        echo "%{name_} is still running and cannot be uninstalled right now. Please stop it and try again later."
        exit 1
    else
        /usr/bin/virsh undefine %{name_}
    fi
fi


%post
if [ $1 = 1 ]; then    # install
    /usr/bin/virsh define %{guest_xmlsavedir}/%{name_}.xml
#   grep %{name_} /etc/hosts > /dev/null 2>/dev/null; ret=$?
#   if test $ret -eq 0; then   # not found in /etc/hosts
#             /usr/bin/augtool -b << EOC
# set /files/etc/hosts/01/ipaddr <HOST_IP_ADDRESS>
# set /files/etc/hosts/01/canonical master.@NET_1_DOMAIN@
# set /files/etc/hosts/01/alias[1] master
# save
# EOC
#   fi
elif [ $1 = 2 ]; then  # update
    if `/usr/bin/virsh list | grep -q %{name_} 2>/dev/null`; then
        echo "%{name_} is running. Run the following later when it's stopped to update its profile:"
        echo "   /usr/bin/virsh define %{guest_xmlsavedir}/%{name_}.xml"
    else
        /usr/bin/virsh undefine %{name_}
        /usr/bin/virsh define %{guest_xmlsavedir}/%{name_}.xml
    fi
fi


%clean
%{__rm} -rf $RPM_BUILD_ROOT


%files  -f delta.files
%defattr(-,root,root,-)
%doc README
%config(missingok) %verify(not md5 size mtime) %{guest_xmldir}/%{name_}.xml


%files  base -f base.files
%defattr(-,root,root,-)
%doc README ssh.config
%config %{guest_xmlsavedir}/%{name_}.xml


%changelog
* __DATE__ @PACKAGE@-builder <root@localhost> - __VER__-1
- Updated to follow changes of others

* Fri Oct 15 2010 @PACKAGE@-builder <root@localhost> - 0.5.3-1
- Eliminated dependency to augeas only available from EPEL

* Thu Sep 17 2009 @PACKAGE@-builder <root@localhost> - 0.5.2-1
- Experimental code to add host entry into /etc/hosts (but commented by default)
- Some minor bug fixes

* Tue Aug 18 2009 @PACKAGE@-builder <root@localhost> - 0.5.1-1
- Fixed scripts/guest.spec.in.in not to contain base image in delta package
- Renamed package; virt-domain-<fqdn>-minimal{,-base}

* Tue Aug  4 2009 @PACKAGE@-builder <root@localhost> - 0.5-1
- Make base images contained in base-minimal sub package

* Sun Jul  5 2009 @PACKAGE@-builder <root@localhost> - 0.4-1
- Fixed a problem of post installation script
- Made guest's xml file saved

* Wed Jul  1 2009 @PACKAGE@-builder <root@localhost> - 0.3-1
- follow build tool updates

* Tue Jun 30 2009 @PACKAGE@-builder <root@localhost> - 0.2-1
- Make delta images backed up

* Mon Jun 29 2009 @PACKAGE@-builder <root@localhost> - 0.1-1
- Initial packaging.
