# RHEL 5
url --url=@AUTOINST_TREE_URL_BASE@/RHEL/5/0/Server/i386/
install
text
lang en_US.UTF-8
keyboard us
skipx
auth --useshadow --enablemd5
firewall --enabled --port=22:tcp --port=5353:udp
firstboot --disable
%include /tmp/network-ks.cfg
rootpw redhat
selinux --disabled
timezone  Asia/Tokyo
zerombr
# if serial console only:
#bootloader --location=mbr --append="console=ttyS0,19200"
bootloader --location=mbr
clearpart --all --initlabel
autopart
key --skip
services --enabled avahi-daemon --disabled atd,cups,gpm,lm_sensors,lvm2-monitor,mcstrans,mdmonitor,netfs,nfslock,ntpd,portmap,rawdevices,restorecond,sendmail,smartd,rhnsd
reboot

# repos
#repo --name=rhel-kstree --baseurl=@AUTOINST_TREE_URL_BASE@/RHEL/5/0/Server/i386/Server/
#repo --name=rhel-cluster-kstree --baseurl=@AUTOINST_TREE_URL_BASE@/RHEL/5/0/Server/i386/Cluster/
#repo --name=rhel-cluster-storage-kstree --baseurl=@AUTOINST_TREE_URL_BASE@/RHEL/5/0/Server/i386/ClusterStorage/
#repo --name=rhel-vt-kstree --baseurl=@AUTOINST_TREE_URL_BASE@/RHEL/5/0/Server/i386/VT/


%packages
# Automatic package selection.
@ Base
avahi
curl
elinks
#kernel-devel
lv
ntp
rpm-build
screen
strace
#systemtap
yum-utils
vim-enhanced
#kexec-tools
#system-config-kdump
-Deployment_Guide-en-US
-NetworkManager
-OpenIPMI
-OpenIPMI-libs
-acpid
-amtu
-apmd
-aspell
-aspell-en
-bluez-gnome
-bluez-libs
-bluez-utils
-ccid
-conman
-coolkey
-cpuspeed
-dos2unix
-eject
-fbset
-finger
-firstboot
-firstboot-tui
-ftp
-hdparm
-ifd-egate
-irda-utils
-irqbalance
-krb5-workstation
-microcode_ctl
-mlocate
-mozldap
-nano
-pam_pkcs11
-pam_ccreds
-pam_smb
-pcmciautils
-pcsc-lite
-ppp
-psacct
-rdate
-rdist
-redhat-release-notes-5Server
-rp-pppoe
-rsh
-specspo
-stunnel
-talk
-telnet
-udftools
-unix2dos
-wpa_supplicant
-yum-updatesd


%pre
(
set -x
set -v

cat /proc/cmdline | sed 's/ /\
/g' | sed -nre '/^[^=]+=[^=]+$/p' > /tmp/boot-params

source /tmp/boot-params   # hostname, etc.

# Make up dummy lspci to avoid the anaconda bug similar to bz#445974.
cat << EOF > /sbin/lspci
#! /bin/sh
exit 0
EOF
chmod +x /sbin/lspci

test -n "${hostname}" && hn_opt="--hostname=${hostname}.local" || hn_opt=""
cat << EOF > /tmp/network-ks.cfg
network --device=eth0 --bootproto=dhcp $hn_opt
network --device=eth1 --bootproto=dhcp --onboot=no --nodns
network --device=eth2 --bootproto=dhcp --nodns
network --device=eth3 --bootproto=dhcp --onboot=no --nodns
EOF
) 2>&1 | tee /tmp/ks.pre.log
%end


%post --nochroot
(
set -x
set -v

test -d /mnt/sysimage/root/setup || mkdir /mnt/sysimage/root/setup
for f in /tmp/boot-params /tmp/*ks.cfg /tmp/ks.pre.log; do
    mv -f $f /mnt/sysimage/root/setup
done

) 2>&1 | tee /mnt/sysimage/tmp/ks.post.nochroot.log
%end


%post
(
set -x
set -v

source /root/setup/boot-params   # hostname, etc.

cat << EOF >> /etc/sysconfig/network
GATEWAYDEV=eth0
EOF

# network --nodns does not look work well:
for f in /etc/sysconfig/network-scripts/ifcfg-eth{1,2,3}; do
    echo "PEERDNS=no" >> $f
done

rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release

cat << EOF > /etc/yum.repos.d/rhel-kstree.repo
[rhel-kstree]
name=Red Hat Enterprise Linux $releasever - $basearch - Server (kickstart tree)
baseurl=@AUTOINST_TREE_URL_BASE@/RHEL/5/0/Server/i386/Server/
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
EOF

cat << EOF >> /etc/inittab

# serial console:
co:2345:respawn:/sbin/agetty ttyS0 115200 vt100-nav
EOF

cat << EOF >> /etc/securetty
ttyS0
EOF


# @see http://osdir.com/ml/kickstart-list/2009-10/msg00005.html
#sed -i -e 's/^timeout=5/serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1 terminal --timeout=5 serial console timeout=5/' -e 's/^splashimage/#&/' /boot/grub/grub.conf
) 2>&1 | tee /root/setup/ks.post.log
%end
