url --url=@AUTOINST_TREE_URL_BASE@/rhel/3/0/as/i386/
install
text
lang en_US.UTF-8
langsupport --default en_US.UTF-8 en_US.UTF-8
keyboard us
mouse genericwheelps/2 --device psaux
skipx
network --device=eth0 --bootproto=dhcp
network --device=eth1 --bootproto=dhcp --nodns
network --device=eth2 --bootproto=dhcp --nodns
network --device=eth3 --bootproto=dhcp --nodns
rootpw redhat
firewall --enabled --port=22:tcp
authconfig --enableshadow --enablemd5
timezone Asia/Tokyo
bootloader --location=mbr
clearpart --all --initlabel
part /boot --fstype ext3 --size=100
part / --fstype ext3 --size=1024 --grow
part swap --size=512
reboot


%pre
(
set -x
set -v

cat /proc/cmdline | sed 's/ /\
/g' | sed -nre '/^[^=]+=[^=]+$/p' > /tmp/boot-params

# Make up dummy lspci to avoid the anaconda bug similar to bz#445974.
cat << EOF > /sbin/lspci
#! /bin/sh
exit 0
EOF
chmod +x /sbin/lspci

) 2>&1 | tee /tmp/ks.pre.log


%packages
@ admin-tools
@ smb-server
@ base-x
@ web-server
@ printing
@ text-internet
@ server-cfg
@ dialup
@ gnome-desktop
@ graphical-internet
@ compat-arch-support
kernel
grub


%post --nochroot
(
set -x
set -v

test -d /mnt/sysimage/root/setup || mkdir /mnt/sysimage/root/setup
for f in /tmp/boot-params /tmp/*ks.cfg /tmp/ks.pre.log; do
    mv -f $f /mnt/sysimage/root/setup
done
) 2>&1 | tee /mnt/sysimage/tmp/ks.post.nochroot.log


%post
(
set -x
set -v

source /root/setup/boot-params   # hostname, etc.

# set gateway device expressly
test -n "${hostname}" && hn="HOSTNAME=${hostname}" || hn=""
cat << EOF >> /etc/sysconfig/network
GATEWAYDEV=eth0
$hn
EOF

# Hack to off eth1 and eth3; anaconda in RHEL3/4 does not support
# "--onboot=<yes|no>" option for network command.
for f in /etc/sysconfig/network-scripts/ifcfg-eth{1,2,3}; do
    sed --in-place -e "s/^ONBOOT=yes/ONBOOT=no/" $f
    echo "PEERDNS=no" >> $f
done

# It seems that anaconda in RHEL3 forgets to add "HWADDR" line in
# /etc/sysconfig/network-scriptfs/ifcfg-ethX (ethX = ksdevice).
# Here we add it expressly.
hwaddr=$(/sbin/ip link show eth0 | sed -nre "s/.*ether ([0-9:]+) brd.*/\1/p")
cat << EOF >> /etc/sysconfig/network-scriptfs/ifcfg-eth0
HWADDR=$hwaddr
TYPE=Ethernet
EOF

rpm --import /usr/share/rhn/RPM-GPG-KEY

# Add local repo
sed --in-place -re 's/^(up2date default)/# \1/g' -e '$a\
dir rhel-kstree @AUTOINST_TREE_URL_BASE@/rhel/3/0/as/i386/' \
/etc/sysconfig/rhn/sources

cat << EOF >> /etc/inittab

# serial console:
co:2345:respawn:/sbin/agetty ttyS0 115200 vt100-nav
EOF

cat << EOF >> /etc/securetty
ttyS0
EOF
) 2>&1 | tee /root/setup/ks.post.log
