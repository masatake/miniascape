#%define nginx_enabled   %(test -f /etc/fedora-release && echo "yes" || echo "no")
%if 0%{?fedora}
%define httpd_name      nginx
%define nginx_enabled   yes
%define qemu_kvm        %{_bindir}/qemu-kvm
%else
%define httpd_name      httpd
%define nginx_enabled   no
%define qemu_kvm        %{_libexecdir}/qemu-kvm
%endif


Name:           @PACKAGE@
Version:        @VERSION@
Release:        1%{?dist}
Summary:        Packaging toolkit for virtualization guests and environment based on libvirt
Group:          Applications/System
License:        GPLv3+
URL:            http://github.com/ssato/miniascape
Source0:        %{name}-%{version}.tar.xz
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
BuildArch:      noarch
BuildRequires:  libvirt
BuildRequires:  qemu-img
Requires:       %{httpd_name}
Requires:       libvirt
Requires:       nfs-utils
Requires:       parted
Requires:       scsi-target-utils
Requires(post): /sbin/service
Requires:       /usr/bin/virsh
Requires:       /usr/bin/qemu-img
Requires:       %{qemu_kvm}
Requires:       python-virtinst
Requires:       rpm-build
Requires:       @PACKAGE@-datasrc


%description
Miniascape is a packaging toolkit for virtualization guests and environment
based on libvirt.

This package contains some core components (libvirt network definitions, iSCSI
configurations, build tools, etc.).


%prep
%setup -q


%build
%configure --enable-nginx=%{nginx_enabled}
make %{?_smp_mflags}


%install
%{__rm} -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT


%clean
%{__rm} -rf $RPM_BUILD_ROOT


%post
/sbin/service %{httpd_name} status > /dev/null 2>&1 && /sbin/service %{httpd_name} reload > /dev/null 2>&1 || :
exit 0


%files
%defattr(-,root,root,-)
%doc README
%dir /var/lib/@PACKAGE@/exports
%config(noreplace) %{_sysconfdir}/%{name}/*
%config(noreplace) %{_sysconfdir}/%{httpd_name}/conf.d/*
%config(noreplace) %{_sysconfdir}/tgt/conf.d/*
%config(noreplace) %{_sysconfdir}/%{name}/profiles/*
%{_sbindir}/*
%{_libexecdir}/%{name}/*
%{_datadir}/libvirt/networks/*
%{_datadir}/%{name}/devel/*
%{_datadir}/%{name}/autoinst/*.cfg


%changelog
* Fri Jan 21 2011 Satoru SATOH <satoru.satoh@gmail.com> - 0.1.20110121-1
- Many bug fixes around vm build process

* Mon Jan 17 2011 Satoru SATOH <satoru.satoh@gmail.com> - 0.1.20110117-1
- Added vm instance profile for rhel-5-6-i386

* Fri Jan 14 2011 Satoru SATOH <satoru.satoh@gmail.com> - 0.1.20110114-1
- Added vm profiles for rhel-5-6-i386

* Wed Dec 15 2010 Satoru SATOH <satoru.satoh@gmail.com> - 0.1.20101215-1
- Added prefix to all custom variables in Makefiles

* Tue Oct 19 2010 Satoru SATOH <satoru.satoh@gmail.com> - 0.1.99-1
- Strip -core from package name
- Re-versioned because its name was changed
- Moved site.cfg into miniascape-data
- Removed the init scripts for dnsmasq
- Removed site and host local stuff at a maximum
- Added nginx configurations. Now it's the default web server for the fedora version
- Made this source publicly accessible
- ... and many enhancements and bug fixes

* Sun Oct 17 2010 Satoru SATOH <ssato@redhat.com> - 0.5.99-1
- Started to refactor entire architecture and restructure the dist
- Renamed from virt-networks to miniascape-core
- Removed dnsmasq startup scripts and related post/pre scriptlets
- Eliminate other hacks in post/pre scriptlets
- Cleaned up spec: most rpmlint errors are gone
- Renamed: miniascape-core -> miniascape
- Migrated miniascape-build

* Thu Apr  8 2010 Satoru SATOH <ssato@redhat.com> - 0.5.7-1
- Added dirty hack for tgtd to install config and patch the initscript 

* Wed Apr  7 2010 Satoru SATOH <ssato@redhat.com> - 0.5.6.1-1
- Use dd instead of qemu-img to create shared disk images

* Sun Mar 28 2010 Satoru SATOH <ssato@redhat.com> - 0.5.6-1
- Fixed wrong dnsmasq hostsfile format
- Added a hack to kill dnsmasq instance started by libvirt

* Tue Jan 26 2010 Satoru SATOH <ssato@redhat.com> - 0.5.5-1
- Fixed build and runtime dependency to qemu-img

* Mon Jan 25 2010 Satoru SATOH <ssato@redhat.com> - 0.5.4-1
- Updated README

* Fri Jan 22 2010 Satoru SATOH <ssato@redhat.com> - 0.5.3-1
- Make iscsi storage not enabled by default for a while to avoid problems

* Fri Jan 22 2010 Satoru SATOH <ssato@redhat.com> - 0.5.2-1
- Make networks and dnsmasq services started by default if libvirtd is running

* Thu Jan 21 2010 Satoru SATOH <ssato@redhat.com> - 0.5.1-1
- Started to make it work with RHEL 5.4+
- Removed augeas dependency due to the above
- Conslidate sub package @PACKAGE@-services
- Switched to dnsmasq from ISC bind and dhcp
- Cleanup makefiles and rpm spec
- Imported create-iscsi-disk-image from virt-cluster

* Thu Nov 30 2009 Satoru SATOH <ssato@redhat.com> - 0.4.12-1
- Corrected dependency to augeas

* Thu Aug 20 2009 Satoru SATOH <ssato@redhat.com> - 0.4.11-1
- Removed iscsi part from virt-networks-services

* Sun Aug  8 2009 Satoru SATOH <ssato@redhat.com> - 0.4.10-1
- experimental Dynamic DNS support (dhcp/dns). 
- config refactorings (dns)

* Wed Aug  5 2009 Satoru SATOH <ssato@redhat.com> - 0.4.9-1
- Added iscsi (netbsd-iscsi) configurations
- Removed services/named/lan.hosts; static host-ip mappings

* Thu Jul  2 2009 Satoru SATOH <ssato@redhat.com> - 0.4.8-1
- Separate virt-networks-kickstart out from this package

* Thu Jul  2 2009 Satoru SATOH <ssato@redhat.com> - 0.4.7-1
- Added host entries for RHEL 5.{4,5,6} and RHEL 6.{0..3} (DHCPd and Bind)
- Made ks.cfg for RHEL 5.4 (beta) will be generated (kickstart)

* Wed Jul  1 2009 Satoru SATOH <ssato@redhat.com> - 0.4.6-1
- Make augtool not run for updates

* Wed Jul  1 2009 Satoru SATOH <ssato@redhat.com> - 0.4.5-1
- Added a hack to avoid bug of anaconda in rhel-3-2 (kickstart)

* Tue Jun 30 2009 Satoru SATOH <ssato@redhat.com> - 0.4.4-1
- added some more host entires (dhcpd/bind)

* Mon Jun 29 2009 Satoru SATOH <ssato@redhat.com> - 0.4.3-1
- added some host entires (dhcpd/bind)
- changed kstree server to binaries.xxxx.xxxxx.redhat.com (httpd)
- integrated kickstart files

* Fri Jun 26 2009 Satoru SATOH <ssato@redhat.com> - 0.4.2-1
- fixed wrong range definitions (dhcpd)
- fixed allowed address specifications (httpd)
- now depends on augeas to add self entry in /etc/hosts

* Thu Jun 25 2009 Satoru SATOH <ssato@redhat.com> - 0.4.1-1
- added some CNAME and A records in named's zone maps
- some packaging cleanups

* Tue Jun 23 2009 Satoru SATOH <ssato@redhat.com> - 0.4-1
- added httpd configuration
- multi-packaged

* Fri Jun 19 2009 Satoru SATOH <ssato@redhat.com> - 0.3.1-1
- added new option "--targets" for vn-manage
- made vn-manage not run in post/pre sections during uninstallation/update
- fixed packaging errors pointed by rpmlint

* Thu Jun 18 2009 Satoru SATOH <ssato@redhat.com> - 0.3-1
- Fixed and enhanced DNS and DHCP server configurations.

* Sat Jun 13 2009 Satoru SATOH <ssato@redhat.com> - 0.2-1
- Changed DNS and DHCP server from dnsmasq to ISC Bind and DHCP.

* Wed Jun  3 2009 Satoru SATOH <ssato@redhat.com> - 0.1-1
- Initial packaging.
