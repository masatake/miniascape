#! /usr/bin/python
#
# packaging virtualization guest domain.
#
# Copyright (C) 2009 Satoru SATOH <satoru.satoh at gmail.com>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation,
# Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
#
#
# @see http://libvirt.org/formatdomain.html
# @see http://www.qemu.org/qemu-doc.html#SEC19
#

import commands
import logging
import optparse
import os
import re
import shutil
import sys

try:
    import xattr   # pyxattr
except ImportError:
    # Make up a 'Null-Object' like class mimics xattr module.
    class xattr:
        @classmethod
        def get_all(*args):
            return ()

        @classmethod
        def set(*args):
            return ()



RPMNAME_PREFIX = 'vm'
RPMNAME_SUFFIX = 'image'



class SrcIsDirError(Exception): pass
class DestNotDirError(Exception): pass



def run(cmd_str):
    return commands.getstatusoutput(cmd_str)


def package_name(domain_name, prefix=RPMNAME_PREFIX, suffix=RPMNAME_SUFFIX):
    return '%s-%s-%s' % (prefix, domain_name, suffix)


def createdir(dir, mode=0700):
    if os.path.exists(dir):
        logging.warn("The dir already exists: '%s'" % dir)
        if not os.path.isdir(dir):
            raise IOError("Not a directory: '%s'" % dir)
    else:
        logging.info("Creating a dir: '%s' (mode: %o)" % (dir, mode))
        os.makedirs(dir, mode)


def copyfile(src, dst, force=False):
    """
    @param  src  source path
    @param  dst  destination to copy to. dst may be a dir.
    """
    assert src != dst, "src == dst!"

    if not os.path.isdir(dst):
        if not force and os.path.exists(dst):
            logging.warn(" Copying destination '%s' already exists! Skipt it." % dst)
            return

    # copy itself and its some metadata (owner, mode, etc.)
    logging.info(" Copying '%s' -> '%s'..." % (src,dst))
    shutil.copy2(src, dst)

    # These are not copyed with the above.
    _xattrs = dict(xattr.get_all(src))
    if _xattrs:
        logging.info(" Copying xattrs...")
        for k,v in _xattrs.iteritems():
            xattr.set(dst, k, v)

    logging.info(" Done.")


def substfile(src, dst, substs={}):
    assert src != dst, "src == dst!"

    content = open(src).read()
    for org, new in substs.iteritems():
        content = content.replace(org, new)

    f = open(dst, 'w')
    f.write(content)
    f.close()


def buildfile_path(buildfile, prefix):
    return os.path.join(prefix, buildfile)


# actions:
def do_setup(domain_name, buildfile_dir, *args):
    """setup packaging dir.
    """
    builddir = package_name(domain_name)

    substs = {
        '@@DOMAIN_NAME@@': domain_name,
    }

    createdir(builddir)
    createdir(os.path.join(builddir, 'data'))
    createdir(os.path.join(builddir, 'm4'))

    #copyfile(buildfile_path('README.in', buildfile_dir), builddir)
    copyfile(buildfile_path('rpm.mk', buildfile_dir), builddir)
    copyfile(buildfile_path('vm-image.spec.in', buildfile_dir), builddir)
    copyfile(buildfile_path('Makefile.am.in', buildfile_dir), os.path.join(builddir, 'Makefile.am'))

    copyfile(buildfile_path('Makefile.am.in', buildfile_dir + 'data')), os.path.join(builddir, 'data', 'Makefile.am'))
    copyfile(buildfile_subpath('libvirt.m4', buildfile_dir, 'm4'), os.path.join(builddir, 'm4'))
    copyfile(buildfile_subpath('qemu.m4', buildfile_dir, 'm4'), os.path.join(builddir, 'm4'))
    copyfile(buildfile_subpath('rpm.m4', buildfile_dir, 'm4'), os.path.join(builddir, 'm4'))
    copyfile(buildfile_subpath('virtinst.m4', buildfile_dir, 'm4'), os.path.join(builddir, 'm4'))

    for image in domain_images:
        copyfile(image, builddir)


def do_build(domain_name, *args):
    """Build RPM of $domain_name
    """
    builddir = package_name(domain_name)

    if not os.path.isdir(builddir):
        do_setup(domain_name)

    os.system("cd %s && autoreconf -vfi && ./configure && make" % builddir)
    os.system("cd %s && make srpm && make rpm" % builddir)


def option_parser():
    parser = optparse.OptionParser("%prog [OPTION ...] COMMAND DOMAIN_NAME\n\n"
        "Commands: setup, build\n")
    parser.add_option('-p', '--path', default='@PACKAGEFILE_DIR@', help='path to build data [%default]')
    parser.add_option('-v', '--verbose', dest='verbose', action="store_true",
        default=False, help='verbose mode')
    parser.add_option('-q', '--quiet', dest='quiet', action="store_true",
        default=False, help='quiet mode')

    return parser


def main():
    action = do_setup
    loglevel = logging.INFO

    parser = option_parser()
    (options, args) = parser.parse_args()

    if options.verbose:
        loglevel = logging.DEBUG
    if options.quiet:
        loglevel = logging.WARN

    # logging.basicConfig() in python older than 2.4 cannot handle kwargs,
    # then exception 'TypeError' will be thrown.
    try:
        logging.basicConfig(level=loglevel)

    except TypeError:
        # To keep backward compatibility. See above comment also.
        logging.getLogger().setLevel(loglevel)

    if len(args) < 2:
        parser.print_help()
        sys.exit(1)

    if args[0].startswith('setu'):
        action = do_setup
    elif args[0].startswith('bui'):
        action = do_build
    else:
        parser.print_usage()

    domain_name = args[1]
    buildfile_dir = options.path

    stat = domain_status(domain_name)
    if stat != libvirt.VIR_DOMAIN_SHUTOFF:
        if stat == libvirt.VIR_DOMAIN_RUNNING:
            logging.error(" VM '%s' is still running. Please shutdown it first." % domain_name)
        else:
            logging.error(" VM '%s' is unknown." % domain_name)

        sys.exit(1)
            
    action(domain_name, buildfile_dir)


if __name__ == '__main__':
    main()

# vim:sw=4:ts=4:et:ft=python:
