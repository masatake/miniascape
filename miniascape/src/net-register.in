#! /bin/bash
#
# Register libvirt network.
#
# Copyright (C) 2010 Satoru SATOH <satoru.satoh at gmail.com>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation,
# Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
#

netxml=$1

# TODO: Generate network uuid and add it in netxml.
#netuuid=$(@UUIDGEN@)
# <uuid>07387532-1d40-31cd-09a6-4a11e443e8ca</uuid>

if test -z "$netxml"; then
  echo "Usage: $0 NET_XML"
  exit 1
fi


/sbin/service libvirtd status 2>/dev/null >/dev/null
is_libvirtd_running=$?

if test $is_libvirtd_running -ne 0; then
  echo -ne "libvirtd is not running. Just install files..."

  # Just install the network xml and make it autostarted.
  install -m 600 $netxml /etc/libvirt/qemu/networks/

  netxml_basename=${netxml##*/}
  (cd /etc/libvirt/qemu/networks/autostart/ && ln -s ../$netxml_basename ./)

  echo "Done."
  #echo "Register it by yourself later as needed: @VIRSH@ define /etc/libvirt/qemu/networks/$netxml_basename"

  exit 0
fi


netname=$(sed -nre 's,.*<name>([^<]+)</name>.*,\1,p' $netxml)

net_exists=$(@VIRSH@ net-list  --all | sed -nre "s/^($netname).*/\1/p")

if test -z "$net_exists"; then  # fresh installation.
  @VIRSH@ net-define $netxml && @VIRSH@ net-autostart $netname && @VIRSH@ net-start $netname

else  # update
  echo "Network $netname already exists. Redefine it by yourself later:"
  echo "   ex. /usr/libexec/@PACKAGE@/virt-net-unregister $netname && \ "
  echo "       /usr/libexec/@PACKAGE@/virt-net-register $netxml"
  echo " "

  # Just install the network xml and make it autostarted.
  install -m 600 $netxml /etc/libvirt/qemu/networks/

  netxml_basename=${netxml##*/}
  (cd /etc/libvirt/qemu/networks/autostart/ && ln -sf ../$netxml_basename ./)
fi

# vim:set ft=sh sw=2 ts=2 et ai si sm:
