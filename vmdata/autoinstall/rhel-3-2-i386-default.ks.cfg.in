# RHEL 3 AS i386 - default package selection
url --url=@AUTOINST_TREE_URL_BASE@/RHEL/3/2/AS/i386/
install
text
lang en_US.UTF-8
langsupport --default en_US.UTF-8 en_US.UTF-8
keyboard us
mouse genericwheelps/2 --device psaux
xconfig --card "Cirrus Logic GD544x" --videoram 16384 --hsync 31.5-90 --vsync 60 --resolution 1280x1024 --depth 24 --startxonboot  --defaultdesktop gnome
network --device=eth0 --bootproto=dhcp
network --device=eth1 --bootproto=dhcp --nodns
network --device=eth2 --bootproto=dhcp --nodns
network --device=eth3 --bootproto=dhcp --nodns
rootpw redhat
firewall --enabled
authconfig --enableshadow --enablemd5
timezone Asia/Tokyo
bootloader --location=mbr
clearpart --all --initlabel
part /boot --fstype ext3 --size=100
part / --fstype ext3 --size=1024 --grow
part swap --size=512
reboot


%pre
# Make up dummy lspci to avoid the anaconda bug similar to bz#445974.
cat << EOF > /sbin/lspci
#! /bin/sh
exit 0
EOF
chmod +x /sbin/lspci


%packages
@ admin-tools
@ smb-server
@ base-x
@ web-server
@ printing
@ text-internet
@ server-cfg
@ dialup
@ gnome-desktop
@ graphical-internet
@ compat-arch-support
kernel
grub


%post --nochroot
cp /tmp/ks.cfg /mnt/sysimage/root/



%post
# set gateway device expressly
cat << EOF >> /etc/sysconfig/network
GATEWAYDEV=eth0
EOF

# Hack to off eth1 and eth3; anaconda in rhel3/4 does not support
# "--onboot=<yes|no>" option for network command.
for f in /etc/sysconfig/network-scripts/ifcfg-eth{1,3}; do
    sed --in-place -e "s/^ONBOOT=yes/ONBOOT=no/" $f
done

# It seems that anaconda in RHEL3 forgets to add "HWADDR" line in
# /etc/sysconfig/network-scriptfs/ifcfg-ethX (ethX = ksdevice).
# Here we add it expressly.
hwaddr=$(/sbin/ip link show eth0 | sed -nre "s/.*ether ([0-9:]+) brd.*/\1/p")
cat << EOF >> /etc/sysconfig/network-scriptfs/ifcfg-eth0
HWADDR=$hwaddr
TYPE=Ethernet
EOF

rpm --import /usr/share/rhn/RPM-GPG-KEY

# Add local repo
sed --in-place -re 's/^(up2date default)/# \1/g' -e '$a\
dir rhel-kstree @AUTOINST_TREE_URL_BASE@/RHEL/3/2/AS/i386/' \
/etc/sysconfig/rhn/sources

