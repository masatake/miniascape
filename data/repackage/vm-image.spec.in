%define domain_imgdir    %{_localstatedir}/lib/libvirt/images
%define domain_xml       %{_sysconfdir}/miniascape/domains/@DOMAIN_NAME@.xml

%define image_u          %(id qemu > /dev/null 2> /dev/null && echo qemu || echo root)
%define image_g          %(id qemu > /dev/null 2> /dev/null && echo qemu || echo root)


# disable debuginfo - it's pointless for qemu images.
%define debug_package   %{nil}


Name:           @PACKAGE@
Version:        @VERSION@
Release:        1%{?dist}
Summary:        KVM/Qemu guest base image and config for %{name}
Group:          Development/System
License:        MIT
URL:            http://localhost
Source0:        %{name}-%{version}.tar.@SOURCE_ZIP_EXT@
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
BuildArch:      @ARCH@
BuildRequires:  automake
BuildRequires:  autoconf
BuildRequires:  qemu-img
Requires:       @VIRSH@
Requires:       qemu-img
Requires:       /sbin/service
# TODO: how to define build-time dependency to libvirt networks?
#Requires:       /etc/libvirt/qemu/networks/net-1.xml
#Requires:       /etc/libvirt/qemu/networks/net-2.xml
#Requires:       /etc/libvirt/qemu/networks/net-3.xml
Provides:       vm-@DOMAIN_NAME@


%description
Virtualization (KVM/Qemu) guest domain image and data.


%prep
%setup -q


%build
test -f configure || autoreconf -vfi
%configure
make %{?_smp_mflags}


%install
%{__rm} -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT


%preun
if [ $1 = 0 ]; then  # erase
    /sbin/service libvirtd status >/dev/null 2>&1 && @VIRSH@ undefine @DOMAIN_NAME@ || :
fi


%post
if [ $1 = 1 ]; then    # install
    /sbin/service libvirtd status >/dev/null 2>&1 && @VIRSH@ define %{domain_xml} || :
elif [ $1 = 2 ]; then  # update
    /sbin/service libvirtd status >/dev/null 2>&1 && \
        (@VIRSH@ undefine @DOMAIN_NAME@ && @VIRSH@ define %{domain_xml}) || :
fi


%clean
%{__rm} -rf $RPM_BUILD_ROOT


%files
%defattr(-,root,root,-)
%doc README
%config(missingok) %verify(not md5 size mtime) %{_sysconfdir}/libvirt/qemu/@DOMAIN_NAME@.xml
%config %{domain_xml}
%defattr(-,%{image_u},%{image_g},-)
%{domain_imgdir}/*


%changelog
* @TIMESTAMP@ vm-builder <vm-builder@localhost> - @VERSION@-1
- Initial packaging.
