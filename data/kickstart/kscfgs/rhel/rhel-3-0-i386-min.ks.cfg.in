# RHEL 3 AS i386 - minimal package selection
url --url=@KSTREE_LOCATION@/RHEL/3/0/i386/default/
install
text
lang en_US.UTF-8
langsupport --default en_US.UTF-8 en_US.UTF-8
keyboard us
mouse genericwheelps/2 --device psaux
skipx
network --device=eth0 --bootproto=dhcp
network --device=eth1 --bootproto=dhcp
network --device=eth2 --bootproto=dhcp
network --device=eth3 --bootproto=dhcp
rootpw --iscrypted @KS_PASSWORD@
firewall --enabled --port=22:tcp
authconfig --enableshadow --enablemd5
timezone Asia/Tokyo
bootloader --location=mbr
clearpart --all --initlabel
part /boot --fstype ext3 --size=100
part / --fstype ext3 --size=1024 --grow
part swap --size=512
reboot


%pre
# Make up dummy lspci to avoid the anaconda bug similar to bz#445974.
cat << EOF > /sbin/lspci
#! /bin/sh
exit 0
EOF
chmod +x /sbin/lspci


%packages
@ base
curl
elinks
ntp
screen
strace
vim-enhanced
# Remove unnecessary rpms to reduce system size at minimum.
-apmd
-aspell
-aspell-config
-dos2unix
-eject
-finger
-ftp
-hdparm
-ipsec-tools
-irda-utils
-isdn4k-utils
-jfsutils
-kernel-pcmcia-cs
-krb5-workstation
-krbafs
-krbafs-utils
-mdadm
-mgetty
-minicom
-mtr
-mt-st
-nano
-pam_ccreds
-pam_smb
-pam_krb5
-pdksh
-ppp
-pspell
-quota
-raidtools
-rdate
-rdist
-redhat-config-mouse
-rp-pppoe
-rsh
-sendmail-doc
-specspo
-stunnel
-talk
-telnet
-unix2dos
-wireless-tools
-wvdial


%post --nochroot
cp /tmp/ks.cfg /mnt/sysimage/root/


%post

# set gateway device expressly
cat << EOF >> /etc/sysconfig/network
GATEWAYDEV=eth0
EOF

# Hack to off eth1 and eth3; anaconda in RHEL3/4 does not support
# "--onboot=<yes|no>" option for network command.
for f in /etc/sysconfig/network-scripts/ifcfg-eth{1,3}; do
    sed --in-place -e "s/^ONBOOT=yes/ONBOOT=no/" $f
done

# It seems that anaconda in RHEL3 forgets to add "HWADDR" line in
# /etc/sysconfig/network-scriptfs/ifcfg-ethX (ethX = ksdevice).
# Here we add it expressly.
hwaddr=$(/sbin/ip link show eth0 | sed -nre "s/.*ether ([0-9:]+) brd.*/\1/p")
cat << EOF >> /etc/sysconfig/network-scriptfs/ifcfg-eth0
HWADDR=$hwaddr
TYPE=Ethernet
EOF


